import { formatOrder, changeDate } from "../utils";
import { base64ToBlob, getImgURL } from "../utils";
const state = {
  items: [],
  orders: [],
  storeID: "store1",
  userID: "customer1",
  currItemID: "",
  currItemNum: 0,
  userPhone: "",
  keyword: "",
  token: "",
  userName: "",
  userImg: "",
};

const getters = {
  filteredItems(state) {
    return state.items.filter((item) => {
      item.statement_date = changeDate(item.statement_date);

      return item.product_name
        .toLowerCase()
        .includes(state.keyword.toLowerCase());
    });
  },

  getOrders(state) {
    return state.orders.map((order) => formatOrder(order));
  },

  currItem(state) {
    return state.items.find((item) => item.product_id == state.currItemID);
  },
};

const mutations = {
  setUserName(state, name) {
    state.userName = name;
  },
  addWaitingOrder(state, order) {
    state.orders.push(order);
  },
  setUserID(state, userID) {
    state.userID = userID;
  },
  setUserImg(state, userImg) {
    state.userImg = userImg;
  },
  setStoreID(state, storeID) {
    state.storeID = storeID;
  },
  setToken(state, token) {
    state.token = token;
  },
  setOrders(state, orders) {
    state.orders = orders;
  },
  setUserPhone(state, userPhone) {
    state.userPhone = userPhone;
  },
  setItems(state, items) {
    items.forEach(item => {
      // const blob = base64ToBlob("0x2F396A2F34414151536B5A4A5267414241514141415141424141442F3277434541416B474277634E4277634E43416748427767484277304843416748427873494351634E49423057496941524578386B4B4451734A426F78484238624C5430744A5455364D7A6F7548423837536A4D73504373354C6A634243676F4B4451304E4467304E4469346C46526B334B7A63794E7934334C5463764E7A63724B7A63724B7973724E7930334E7A63724E7973334B7973334B7973724B7930744B7973334E7A63774E7934744E7934724B2F2F4141424549414B67424C414D4245514143455145444551482F7841416241414542415145424151454241414141414141414141414141514D434267554842502F454144675141514542414145444151514643516744414141414141414241674D454252454745684D55595345785156467846526369675A47556F6248534D6A4E56596E4E306F734948466A622F7841416141514542415145424151454141414141414141414141414241414947417751462F3851414C684542415141424177494342776B42414141414141414141414543417751524954455355524D55496B4678736641464654497A556D47426F6345302F396F4144414D4241414952417845415077447A6C6A44746B61534A493068494B4341674B47676851306C4943687042536B49306C4B476B454B306767615155454B30676F4B556F4B4342494B43684953456C7363712B6C7A59556A53524A476B4A42515145425130454B476B7041554E494B55684770557051306768576B454453436768576B4642536C4251514A4251554A43547178796A3655734B63324649306B535270435155454241554E424367705767464251306C495271564B554E49495670424130676F49556F6151557051554543515546435457787962364846684B57464F62436B61534A493068494B4341674B4767685155725143676F61536B49314B6C4B476B454B306767615155454B554E494B556F4B4342494B436D396A6B58753573614C69776C4C436E4E68534E4A456B61516B46424151464451516F4B566F4251554E4A5345616C536C445343466151514E494B43464B476B464B554642416B46503672484950647859306E4E6A5263574570595535734B5270496B6A53456B4B55674943686F4955464B3067674B476B70434E524B554E49495670424130676F49556F6151557051554543542B3278794432635745754C476B3573614C69776C4B5535734B5270496B6A53456B4B55674943686F4955464B30416F4B476B70434E4A5368704243744949476B4642436C4453436C4B436770394778787A305A324E46785953347361546D786F754C435570546D7770476B69534E495351705341674B4767685155725343416F61536B49306C4B476B454B306767615155454B554E494B556F4B6656316C787372624F786F7337476934734A63574E4A7A59533473614B55707A59556A53524A476B4A495570415146506F39703746336A726272386E39447A39566E46396E664C5048487734763365316645382F4C367A7A493864586361576C2B5A6E772B742B622F7742576634666E392B342F366C34342B6637783233362F3672506E39432B71385975723276664A4D7A7A5A7739546A6C312B79587A2B777A50487A4F4F2F3231764870506D383776473837316E6B78766A354D61754E34354D657876462B367A374B3948317979395A554B4368704B516A53556F61515172534342704251517051306770536E32645A635A4B307A314770537A73614C4F786F754C4358466A53633245754C47696C4B63324649306B5352704353464B51654E58364D2B5061312B6A6E7A39586B6A7431723350722F414C6A3158513876513972376231484E322F6F4F3364743439386E77764C65446655636C382B62757A366673382F6A614D664E2B58734E4C48566D6534314D65637372373248512B6B76552F4C3033467A64563358506163395450504278647A37727669352B58395832667A2B5238556E7561314E35743863726A6A70654C6A796B344F50707574375A79397A6E652B3864373762312F443066762B7961364C71746454307663755436665033797A7A374D3861386652712B57752F484556797731357033523073626A6237585045732B757657637566583078314853656D75356537342B4C71653839747336326363385A33795A6D503076343266684A3979773663773748324D746651353659586F386539583641514644535568476B7051306768576B4544534367685368704254373273754C5450575770576D656F314B57646A525A324E46785953347361546D776C7859305570546D7770476B69534E4953517070772F3376462F71352F6D576375316536395966442F6E45364434723266682F6664443733322F37506A7A397679553750797470347655632F4433397038542F414D6A66462F3841732F63766A76622B7650776E76663748772F696550592F792F58352B66744848732B6E37503850712B48672F6E342F7639646E307537652B2F4E373254342F322F6950797272386E652B2F76766876472F77446A342B72356577702B4B76445334396531665239754F76782B76395A2B71763841354430522F742B662F716366785A4862663957362F683435365030566151514644535568476B7051306768576B454453436768536770364C575846686E724C525A3679314B307A314770557A31476F307A73614C69776C7859306E4E684C69786F70536E4E68534E4A456B61516B65645436632B50617A2B6C6E7A39586B6A7630723350722F743356646479394433547476543833634F67376A32336A7879664338563539395079547A356D3550702B33782B4D716C397A38765961754F6C4D3976715A635A5932393248512B7266552F46303346773956327250647030303863484C335074572B586E34767876322F7A2B5A346E6D3171625062355A584C48563850506C5A772B58335066716A75765859333148526477366E6D386536344F486936445844302F545437732B666F6B2B6476362F6F616E45652B6E4E7474384C4D63354A385A792B6C362B754F447050545862666563664C31485A2B32323962654F2B6334354E54483650384C6677732B39592B2B7644592B336C72362F48544F39486A6D33364155725343416F61536B49306C4B476B454B306767615155454B553950724C697057476573744E4D745A614C50575770576D656F314B6D656F30307A73614C69776C7859306E4E684C69786F70536E4E68534E4A456B61516B2B6A326E7676654F6975767966313350307564333274386338636E44752F66374E387A7A382F724C77316476706176356D484C3633357750566E2B495A2F6365503841705845665039323762394839316E7A2B7576566538584E3770766A6D70347434656D7878612F624A356E366A784450732F6253382B6A2B627A7539373176577554652B546B3371373379636D2F6233795837376674725436354A4A78496A53516F4B56704241554E4A534561536C445343464B47674E494B436E72645A63544B386D577374536C6E724C525A617930307A316C7156706E714E53706E714E52706E59305846684C6978704F624358466A53536B7562436B61534A4930684A436C4943416F61434642537449494368704B516A53556F61515170513042704254324F73754A65445057544B3079316C715573395A614C4C57576D6D65737453744D395271564D39527156706E59305846684C6978704F624358466A5353776C7A59556A53524A476B4A4955704151464451516F4B56704241554E4A534561536C445343464B47674E4A376257584553766E5A6179305765736D56706C724C584A5A367930575773744E4D395A616C615A366A55715A366A5572544F786F754C4358466A53633245754C476B6C684C6D7770436B4B52704353464B5145425130454B436C6151514644535568476B70513067685368726B506461793468387250575770576D577374466E724A6C615A6179314B576573744E4D745A614C50575770576D656F314B6D656F314B307A73614C69776C7859306E4E684C6978704A595335734B5170436B61516B68536B4241554E4243677053686F4251306C4952704B554E49495570372F57584553766A5A617930576573744E4D745A61685A36795A576D577374536C6E724C54544C5757697A316C7156706E714E53706E714E53744D37476934734A63574E4A7A59533473615357457562436B4B5170476B4A4955704151464451516F4B556F6141554E4A534561536C44534348364A714F4866437A316C7156706C724C525A3679303079316C71466E724A6C615A6179314B576573744E4D745A614C50575770576D656F314B6D656F314B303473614C4F776C7859306E4E684C6978704A595335734B5170436B61516B68536B4241554E4243677053686F4251306C4952704B554650306A575845507A32656F537A316C7156706C724C525A3679303079316C71466E724A6C615A6179314B576573744E4D745A614C50575770576D656F314B6D656F314B303473614C4F776C7859306E4E684C6978704A595335734B5170436B61516B68536B4241554E4243677053686F4251306C4952704B552F546452773738356C724C525A36684C50575770576D577374466E724C54544C57576F5765736D56706C724C55705A3679303079316C6F73395A616C615A366A55715A366A55725469786F73374358466A53633245754C476B6C684C6D7770436B4B52704353464B5145425130454B436C4B4767464453556844796E2F2F32513D3D", "image/png");
      // item.product_picture = getImgURL(blob);
      // console.log(item.product_picture);
      item.product_picture = "data:image/jpeg;base64,0x2F396A2F34414151536B5A4A5267414241514141415141424141442F3277434541416B474277634E4277634E43416748427767484277304843416748427873494351634E49423057496941524578386B4B4451734A426F78484238624C5430744A5455364D7A6F7548423837536A4D73504373354C6A634243676F4B4451304E4467304E4469346C46526B334B7A63794E7934334C5463764E7A63724B7A63724B7973724E7930334E7A63724E7973334B7973334B7973724B7930744B7973334E7A63774E7934744E7934724B2F2F4141424549414B67424C414D4245514143455145444551482F7841416241414542415145424151454241414141414141414141414141514D434267554842502F454144675141514542414145444151514643516744414141414141414241674D454252454745684D55595345785156467846526369675A47556F6248534D6A4E56596E4E306F734948466A622F7841416141514542415145424151454141414141414141414141414241414947417751462F3851414C684542415141424177494342776B42414141414141414141414543417751524954455355524D55496B4678736641464654497A556D47426F6345302F396F4144414D4241414952417845415077447A6C6A44746B61534A493068494B4341674B47676851306C4943687042536B49306C4B476B454B306767615155454B30676F4B556F4B4342494B43684953456C7363712B6C7A59556A53524A476B4A42515145425130454B476B7041554E494B55684770557051306768576B454453436768576B4642536C4251514A4251554A43547178796A3655734B63324649306B535270435155454241554E424367705767464251306C495271564B554E49495670424130676F49556F6151557051554543515546435457787962364846684B57464F62436B61534A493068494B4341674B4767685155725143676F61536B49314B6C4B476B454B306767615155454B554E494B556F4B4342494B436D396A6B58753573614C69776C4C436E4E68534E4A456B61516B46424151464451516F4B566F4251554E4A5345616C536C445343466151514E494B43464B476B464B554642416B46503672484950647859306E4E6A5263574570595535734B5270496B6A53456B4B55674943686F4955464B3067674B476B70434E524B554E49495670424130676F49556F6151557051554543542B3278794432635745754C476B3573614C69776C4B5535734B5270496B6A53456B4B55674943686F4955464B30416F4B476B70434E4A5368704243744949476B4642436C4453436C4B436770394778787A305A324E46785953347361546D786F754C435570546D7770476B69534E495351705341674B4767685155725343416F61536B49306C4B476B454B306767615155454B554E494B556F4B6656316C787372624F786F7337476934734A63574E4A7A59533473614B55707A59556A53524A476B4A495570415146506F39703746336A726272386E39447A39566E46396E664C5048487734763365316645382F4C367A7A493864586361576C2B5A6E772B742B622F7742576634666E392B342F366C34342B6637783233362F3672506E39432B71385975723276664A4D7A7A5A7739546A6C312B79587A2B777A50487A4F4F2F3231764870506D383776473837316E6B78766A354D61754E34354D657876462B367A374B3948317979395A554B4368704B516A53556F61515172534342704251517051306770536E32645A635A4B307A314770537A73614C4F786F754C4358466A53633245754C47696C4B63324649306B5352704353464B51654E58364D2B5061312B6A6E7A39586B6A7431723350722F414C6A3158513876513972376231484E322F6F4F3364743439386E77764C65446655636C382B62757A366673382F6A614D664E2B58734E4C48566D6534314D65637372373248512B6B76552F4C3033467A64563358506163395450504278647A37727669352B58395832667A2B5238556E7561314E35743863726A6A70654C6A796B344F50707574375A79397A6E652B3864373762312F443066762B7961364C71746454307663755436665033797A7A374D3861386652712B57752F484556797731357033523073626A6237585045732B757657637566583078314853656D75356537342B4C71653839747336326363385A33795A6D503076343266684A3979773663773748324D746651353659586F386539583641514644535568476B7051306768576B4544534367685368704254373273754C5450575770576D656F314B57646A525A324E46785953347361546D776C7859305570546D7770476B69534E4953517070772F3376462F71352F6D576375316536395966442F6E45364434723266682F6664443733322F37506A7A397679553750797470347655632F4433397038542F414D6A66462F3841732F63766A76622B7650776E76663748772F696550592F792F58352B66744848732B6E37503850712B48672F6E342F7639646E307537652B2F4E373254342F322F6950797272386E652B2F76766876472F77446A342B72356577702B4B76445334396531665239754F76782B76395A2B71763841354430522F742B662F716366785A4862663957362F683435365030566151514644535568476B7051306768576B454453436768536770364C575846686E724C525A3679314B307A314770557A31476F307A73614C69776C7859306E4E684C69786F70536E4E68534E4A456B61516B65645436632B50617A2B6C6E7A39586B6A7630723350722F743356646479394433547476543833634F67376A32336A7879664338563539395079547A356D3550702B33782B4D716C397A38765961754F6C4D3976715A635A5932393248512B7266552F46303346773956327250647030303863484C335074572B586E34767876322F7A2B5A346E6D3171625062355A584C48563850506C5A772B58335066716A75765859333148526477366E6D386536344F486936445844302F545437732B666F6B2B6476362F6F616E45652B6E4E7474384C4D63354A385A792B6C362B754F447050545862666563664C31485A2B32323962654F2B6334354E54483650384C6677732B39592B2B7644592B336C72362F48544F39486A6D33364155725343416F61536B49306C4B476B454B306767615155454B553950724C697057476573744E4D745A614C50575770576D656F314B6D656F30307A73614C69776C7859306E4E684C69786F70536E4E68534E4A456B61516B2B6A326E7676654F6975767966313350307564333274386338636E44752F66374E387A7A382F724C77316476706176356D484C3633357750566E2B495A2F6365503841705845665039323762394839316E7A2B7576566538584E3770766A6D70347434656D7878612F624A356E366A784450732F6253382B6A2B627A7539373176577554652B546B3371373379636D2F6233795837376674725436354A4A78496A53516F4B56704241554E4A534561536C445343464B47674E494B436E72645A63544B386D577374536C6E724C525A617930307A316C7156706E714E53706E714E52706E59305846684C6978704F624358466A53536B7562436B61534A4930684A436C4943416F61434642537449494368704B516A53556F61515170513042704254324F73754A65445057544B3079316C715573395A614C4C57576D6D65737453744D395271564D39527156706E59305846684C6978704F624358466A5353776C7A59556A53524A476B4A4955704151464451516F4B56704241554E4A534561536C445343464B47674E4A376257584553766E5A6179305765736D56706C724C584A5A367930575773744E4D395A616C615A366A55715A366A5572544F786F754C4358466A53633245754C476B6C684C6D7770436B4B52704353464B5145425130454B436C6151514644535568476B70513067685368726B506461793468387250575770576D577374466E724A6C615A6179314B576573744E4D745A614C50575770576D656F314B6D656F314B307A73614C69776C7859306E4E684C6978704A595335734B5170436B61516B68536B4241554E4243677053686F4251306C4952704B554E49495570372F57584553766A5A617930576573744E4D745A61685A36795A576D577374536C6E724C54544C5757697A316C7156706E714E53706E714E53744D37476934734A63574E4A7A59533473615357457562436B4B5170476B4A4955704151464451516F4B556F6141554E4A534561536C44534348364A714F4866437A316C7156706C724C525A3679303079316C71466E724A6C615A6179314B576573744E4D745A614C50575770576D656F314B6D656F314B303473614C4F776C7859306E4E684C6978704A595335734B5170436B61516B68536B4241554E4243677053686F4251306C4952704B554650306A575845507A32656F537A316C7156706C724C525A3679303079316C71466E724A6C615A6179314B576573744E4D745A614C50575770576D656F314B6D656F314B303473614C4F776C7859306E4E684C6978704A595335734B5170436B61516B68536B4241554E4243677053686F4251306C4952704B552F546452773738356C724C525A36684C50575770576D577374466E724C54544C57576F5765736D56706C724C55705A3679303079316C6F73395A616C615A366A55715A366A55725469786F73374358466A53633245754C476B6C684C6D7770436B4B52704353464B5145425130454B436C4B4767464453556844796E2F2F32513D3D";
    });
    state.items = items;
  },
  setCurrItemID(state, itemID) {
    state.currItemID = itemID;
  },
  setCurrItemNum(state, itemNum) {
    state.currItemNum = itemNum;
  },
  setKeyword(state, keyword) {
    state.keyword = keyword;
  },
};

const actions = {
  async fetchItems({ commit, state }) {
    const response = await fetch(`/api/product`, {
      headers: {
        Authorization: `Bearer ${state.token}`,
      },
    });
    const data = await response.json();
    commit("setItems", data);
  },

  async fetchOrders({ commit, state }) {
    const response = await fetch(`/api/order/${state.userID}`, {
      headers: {
        Authorization: `Bearer ${state.token}`,
      },
    });
    const data = await response.json();
    commit("setOrders", data);
  },

  async fetchToken({ commit, state }) {
    const response = await fetch(`/api/user`, {
      method: "POST",
      headers: {
        "ngrok-skip-browser-warning": "69420",
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        userid: state.userID,
        store_id: state.storeID,
      }),
    });
    const data = await response.json();
    commit("setToken", data.access_token);
  },

  async fetchUserInit({ dispatch }) {
    try {
      await dispatch("fetchToken");
      await Promise.all([dispatch("fetchItems"), dispatch("fetchOrders")]);
    } catch (error) {
      console.error("Error in fetchUserInit:", error);
    }
  },
};

export default {
  namespaced: true,
  state,
  getters,
  mutations,
  actions,
};
